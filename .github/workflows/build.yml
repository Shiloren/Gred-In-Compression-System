name: Build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  benchmark-gate:
    name: Benchmark Gate (Empirical)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run empirical benchmark gate (50x)
        run: npm run bench:gate

      - name: Run dedicated 50x guarantee validation
        run: npm run bench:validate-50x

      - name: Run empirical security benchmark gate
        run: npm run bench:security

      - name: Run empirical edge-case benchmark gate
        run: npm run bench:edge-cases

      - name: Run empirical codec-stats benchmark gate
        run: npm run bench:codec-stats

      - name: Upload benchmark artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: empirical-benchmark-report
          path: |
            bench/results/latest/empirical-report.json
            bench/results/latest/empirical-report.md
            bench/results/latest/empirical-strict-report.json
            bench/results/latest/empirical-strict-report.txt
            bench/results/latest/validate-50x-report.json
            bench/results/latest/validate-50x-report.md
            bench/results/latest/empirical-security-report.json
            bench/results/latest/empirical-security-report.md
            bench/results/latest/empirical-edge-cases-report.json
            bench/results/latest/empirical-edge-cases-report.md
            bench/results/latest/empirical-codec-stats-report.json
            bench/results/latest/empirical-codec-stats-report.md

  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    env:
      # Expose as env so we can safely test presence in `if:` expressions.
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: https://sonarcloud.io
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        # GitHub runners use npm v10+ which is stricter with peer deps.
        # This repo currently has an ESLint peer dependency constraint mismatch
        # (@eslint/js@10 wants eslint@^10, while eslint is pinned to v9).
        run: npm ci --legacy-peer-deps

      - name: Run tests (optional)
        run: npm test
        continue-on-error: true

      - name: Sonar scan precheck
        if: always()
        run: |
          if [ -z "$SONAR_TOKEN" ]; then
            echo "SONAR_TOKEN secret is NOT set. Sonar scan will be skipped (common on forks/PRs or if the secret is missing)."
          else
            echo "SONAR_TOKEN secret is set. Sonar scan will run."
          fi

      - name: SonarQube Scan
        if: ${{ env.SONAR_TOKEN != '' }}
        uses: SonarSource/sonarqube-scan-action@v6
        with:
          # Pin org + projectKey explicitly so the scan never “drifts” due to autodetection.
          args: >
            -Dsonar.organization=shiloren
            -Dsonar.projectKey=Shiloren_Gred-In-Compression-System
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

      - name: SonarQube Scan (skipped)
        if: ${{ env.SONAR_TOKEN == '' }}
        run: echo "Skipping Sonar scan because SONAR_TOKEN is missing."

      # Optional convenience: print Quality Gate + a short list of issues into the GH Actions logs.
      # This lets us review the findings without manually opening SonarCloud.
      - name: SonarCloud Summary (Quality Gate + top issues)
        if: ${{ env.SONAR_TOKEN != '' }}
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
          SONAR_PROJECT_KEY: Shiloren_Gred-In-Compression-System
          SONAR_BRANCH: ${{ github.ref_name }}
        run: |
          set +x
          echo "== Quality Gate (project=${SONAR_PROJECT_KEY}, branch=${SONAR_BRANCH}) =="
          QG_URL="${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}&branch=${SONAR_BRANCH}"
          QG_RESP=$(curl -sS -u "${SONAR_TOKEN}:" -w "\nHTTP:%{http_code}\n" "$QG_URL" 2>&1 || true)
          printf "%s" "$QG_RESP" > qg_resp.txt
          python - <<'PY' < qg_resp.txt
          import json, sys
          raw = sys.stdin.read()
          # Separate body and HTTP code footer
          body, _, footer = raw.rpartition("\nHTTP:")
          http = footer.strip() if footer else "unknown"
          body = body.strip()
          print("http:", http)
          if not body:
              print("empty response")
              raise SystemExit(0)
          if not (body.startswith('{') or body.startswith('[')):
              print("non-json response (first 200 chars):")
              print(body[:200])
              raise SystemExit(0)
          data = json.loads(body)
          if 'errors' in data:
              print('errors:', data['errors'])
              raise SystemExit(0)
          ps=data.get('projectStatus', {})
          print('status:', ps.get('status'))
          for c in ps.get('conditions', [])[:20]:
              metric=c.get('metricKey')
              status=c.get('status')
              actual=c.get('actualValue')
              err=c.get('errorThreshold')
              print(f"- {metric}: {status} (actual={actual} threshold={err})")
          PY

          echo ""
          echo "== Top issues (first 50) =="
          ISS_URL="${SONAR_HOST_URL}/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&branch=${SONAR_BRANCH}&resolved=false&ps=50"
          ISS_RESP=$(curl -sS -u "${SONAR_TOKEN}:" -w "\nHTTP:%{http_code}\n" "$ISS_URL" 2>&1 || true)
          printf "%s" "$ISS_RESP" > iss_resp.txt
          python - <<'PY' < iss_resp.txt
          import json, sys
          raw = sys.stdin.read()
          body, _, footer = raw.rpartition("\nHTTP:")
          http = footer.strip() if footer else "unknown"
          body = body.strip()
          print("http:", http)
          if not body:
              print("empty response")
              raise SystemExit(0)
          if not (body.startswith('{') or body.startswith('[')):
              print("non-json response (first 200 chars):")
              print(body[:200])
              raise SystemExit(0)
          data = json.loads(body)
          if 'errors' in data:
              print('errors:', data['errors'])
              raise SystemExit(0)
          issues=data.get('issues', [])
          print('count:', len(issues))
          for i, it in enumerate(issues, 1):
              rule=it.get('rule')
              sev=it.get('severity')
              typ=it.get('type')
              msg=it.get('message')
              comp=it.get('component')
              line=it.get('line')
              print(f"{i:02d}. [{sev}][{typ}] {comp}:{line} - {msg} ({rule})")
          PY

      - name: SonarCloud Summary (skipped)
        if: ${{ env.SONAR_TOKEN == '' }}
        run: echo "Skipping SonarCloud summary because SONAR_TOKEN is missing."
